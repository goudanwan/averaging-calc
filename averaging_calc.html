<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>加仓回本计算器</title>
<style>
  :root { --fg:#111; --bg:#f6f7fb; --card:#fff; --muted:#6b7280; --pri:#007aff; --pri2:#005ecb; --ok:#10b981; --err:#ef4444; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font:16px -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial}
  .wrap{max-width:900px;margin:22px auto;padding:16px}
  h1{font-size:20px;margin:0 0 12px 0}
  .tabs{display:flex;gap:8px;margin:10px 0 16px 0;flex-wrap:wrap}
  .tab{padding:10px 14px;border-radius:12px;background:#e9eef6;color:#111;border:1px solid #d6deea;cursor:pointer;font-weight:600}
  .tab.active{background:var(--pri);color:#fff;border-color:var(--pri)}
  .card{background:var(--card);border-radius:16px;padding:16px;box-shadow:0 2px 6px rgba(0,0,0,.06)}
  .row{display:flex;gap:12px;flex-wrap:wrap;margin:8px 0}
  .field{flex:1 1 240px;display:flex;flex-direction:column}
  label{font-size:13px;color:var(--muted);margin-bottom:6px}
  input[type="number"]{padding:12px;border:1px solid #e5e7eb;border-radius:12px;font-size:16px;background:#fff}
  .seg{display:flex;gap:10px;flex-wrap:wrap}
  .seg label{font-size:14px;color:#111}
  button{width:100%;padding:14px 16px;border:0;border-radius:12px;background:var(--pri);color:#fff;font-weight:700;font-size:16px;margin-top:8px}
  button:active{background:var(--pri2)}
  .result{margin-top:14px;padding:12px;border-radius:12px;background:#fff;border:1px solid #e5e7eb}
  .muted{color:var(--muted);font-size:13px}
  .ok{color:var(--ok)} .err{color:var(--err)}
  .num{font-variant-numeric:tabular-nums}
  .hidden{display:none}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:720px){ .grid2{grid-template-columns:1fr} }
</style>
</head>
<body>
<div class="wrap">
  <h1>加仓回本计算器</h1>
  <div class="tabs">
    <div class="tab active" data-pane="single">单日加仓</div>
    <div class="tab" data-pane="day2">第2天加仓（两日连续下跌）</div>
  </div>

  <!-- 单日加仓 -->
  <div id="pane-single" class="card">
    <div class="row">
      <div class="field">
        <label>当前持仓金额（元）</label>
        <input id="s-current" type="number" inputmode="decimal">
      </div>
    </div>

    <div class="row">
      <div class="field" style="flex:1 1 100%">
        <label>计算方式</label>
        <div class="seg">
          <label><input type="radio" name="s-mode" value="percent" checked> 按跌幅百分比</label>
          <label><input type="radio" name="s-mode" value="loss"> 按亏损金额</label>
        </div>
      </div>
    </div>

    <div class="row" id="s-percentRow">
      <div class="field">
        <label>下跌百分比（%）</label>
        <input id="s-drop" type="number" inputmode="decimal">
      </div>
    </div>

    <div class="row hidden" id="s-lossRow">
      <div class="field">
        <label>亏损金额（元）</label>
        <input id="s-loss" type="number" inputmode="decimal">
      </div>
    </div>

    <!-- 亏损预估显示 -->
    <div class="muted" id="s-loss-est" style="margin-top:6px;display:none">
      按此跌幅估算亏损：<span id="s-loss-est-val" class="num">0.00</span> 元
    </div>

    <button id="s-calcBtn">计算最少需要加仓多少</button>
    <div id="s-msg" class="hint" aria-live="polite"></div>
    <div id="s-out" class="result hidden">
      <div>至少需要加仓：<strong class="num" id="s-need"></strong> 元</div>
      <div class="muted">加仓后持仓总额：<span class="num" id="s-total"></span> 元</div>
      <div class="muted">用于计算的跌幅：<span class="num" id="s-usedDrop"></span>%</div>
    </div>
  </div>

  <br>

  <!-- 两日下跌 -->
  <div id="pane-day2" class="card hidden">
    <div class="grid2">
      <div class="field">
        <label>原始持仓金额 C（元）</label>
        <input id="d2-current" type="number" inputmode="decimal">
      </div>
      <div class="field">
        <label>第1天跌幅 d₁（%）</label>
        <input id="d2-d1" type="number" inputmode="decimal">
      </div>
      <div class="field">
        <label>第2天跌幅 d₂（%）</label>
        <input id="d2-d2" type="number" inputmode="decimal">
      </div>
    </div>

    <!-- 两日亏损预估 -->
    <div class="muted" id="d2-loss-est" style="margin-top:6px;display:none">
      两日合计跌幅：<span id="d2-total-drop" class="num">0.000</span>%，
      估算亏损：<span id="d2-loss-val" class="num">0.00</span> 元
    </div>

    <div class="row">
      <div class="field">
        <label>目标回本点</label>
        <div class="seg" id="d2-target-seg">
          <label><input type="radio" name="d2-target" value="P0" checked> 回原价 P₀</label>
          <label><input type="radio" name="d2-target" value="P1"> 回第1天价 P₁</label>
          <label><input type="radio" name="d2-target" value="rebound"> 从第2天反弹 k%</label>
        </div>
      </div>
    </div>
    <div class="row hidden" id="d2-k-wrap">
      <div class="field">
        <label>k（%）</label>
        <input id="d2-k" type="number" inputmode="decimal">
      </div>
    </div>

    <button id="d2-calcBtn">计算第2天最少需要加仓多少</button>
    <div id="d2-msg" class="hint" aria-live="polite"></div>
    <div id="d2-out" class="result hidden">
      <div>第2天至少需要加仓：<strong class="num" id="d2-need"></strong> 元</div>
      <div class="muted">两日连跌后的当前价：<span class="num" id="d2-P2"></span>（以 P₀ = 1 计）</div>
      <div class="muted">选定目标价：<span class="num" id="d2-PT"></span>（以 P₀ = 1 计）</div>
      <div class="muted">加仓后持仓总额：<span class="num" id="d2-total"></span> 元</div>
    </div>
  </div>
</div>

<script>
function n(v){ return Number.parseFloat(v) }
function fmt(v){ return (isFinite(v)? Number(v).toFixed(2) : '-').replace(/\B(?=(\d{3})+(?!\d))/g, ',') }

// Tabs
document.querySelectorAll('.tab').forEach(t=>{
  t.addEventListener('click', ()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    document.getElementById('pane-single').classList.toggle('hidden', t.dataset.pane!=='single');
    document.getElementById('pane-day2').classList.toggle('hidden', t.dataset.pane!=='day2');
  });
});

// --- 单日 ---
const sModeEls = document.querySelectorAll('input[name="s-mode"]');
const sPercentRow = document.getElementById('s-percentRow');
const sLossRow = document.getElementById('s-lossRow');

sModeEls.forEach(r=>{
  r.addEventListener('change', ()=>{
    const m = document.querySelector('input[name="s-mode"]:checked').value;
    sPercentRow.classList.toggle('hidden', m!=='percent');
    sLossRow.classList.toggle('hidden', m!=='loss');
    document.getElementById('s-out').classList.add('hidden');
    document.getElementById('s-msg').textContent='';
    sUpdateLossPreview();
  });
});

function sUpdateLossPreview(){
  const C = n(document.getElementById('s-current').value);
  const mode = document.querySelector('input[name="s-mode"]:checked').value;
  const estWrap = document.getElementById('s-loss-est');
  const estVal  = document.getElementById('s-loss-est-val');
  if(mode !== 'percent'){ estWrap.style.display = 'none'; return; }
  const d = n(document.getElementById('s-drop').value)/100;
  if(isFinite(C)&&C>0&&isFinite(d)&&d>0&&d<1){
    const L = C * d;
    estVal.textContent = fmt(L);
    estWrap.style.display = '';
  }else{
    estWrap.style.display = 'none';
  }
}
document.getElementById('s-current').addEventListener('input', sUpdateLossPreview);
document.getElementById('s-drop').addEventListener('input', sUpdateLossPreview);

document.getElementById('s-calcBtn').addEventListener('click', ()=>{
  const C = n(document.getElementById('s-current').value);
  const mode = document.querySelector('input[name="s-mode"]:checked').value;
  const msg = document.getElementById('s-msg');
  const out = document.getElementById('s-out');
  if(!isFinite(C) || C<=0){ msg.innerHTML = '<span class="err">请输入有效的持仓金额。</span>'; out.classList.add('hidden'); return; }
  let d = NaN, X = NaN;
  if(mode==='percent'){
    d = n(document.getElementById('s-drop').value)/100;
    if(!isFinite(d) || d<=0 || d>=1){ msg.innerHTML = '<span class="err">下跌百分比需在 0% ~ 100% 之间。</span>'; out.classList.add('hidden'); return; }
    X = C * (d/(1-d));
  }else{
    const L = n(document.getElementById('s-loss').value);
    if(!isFinite(L) || L<=0 || L>=C){ msg.innerHTML = '<span class="err">亏损金额需 >0 且 <持仓金额。</span>'; out.classList.add('hidden'); return; }
    d = L / C;
    X = L / (1 - L/C);
  }
  document.getElementById('s-need').textContent = fmt(X);
  document.getElementById('s-total').textContent = fmt(C + X);
  document.getElementById('s-usedDrop').textContent = (d*100).toFixed(3);
  msg.innerHTML = '<span class="ok">已计算完成。</span>';
  out.classList.remove('hidden');
});

// --- 两日 ---
const targetSeg = document.getElementById('d2-target-seg');
const kWrap = document.getElementById('d2-k-wrap');
targetSeg.addEventListener('change', ()=>{
  const v = document.querySelector('input[name="d2-target"]:checked').value;
  kWrap.classList.toggle('hidden', v!=='rebound');
  document.getElementById('d2-out').classList.add('hidden');
  document.getElementById('d2-msg').textContent='';
});

function d2UpdateLossPreview(){
  const C  = n(document.getElementById('d2-current').value);
  const d1 = n(document.getElementById('d2-d1').value)/100;
  const d2 = n(document.getElementById('d2-d2').value)/100;
  const wrap = document.getElementById('d2-loss-est');
  const dropEl = document.getElementById('d2-total-drop');
  const lossEl = document.getElementById('d2-loss-val');
  if(isFinite(C)&&C>0 && isFinite(d1)&&d1>0&&d1<1 && isFinite(d2)&&d2>0&&d2<1){
    const dTotal = 1 - (1 - d1)*(1 - d2);
    const L = C * dTotal;
    dropEl.textContent = (dTotal*100).toFixed(3);
    lossEl.textContent = fmt(L);
    wrap.style.display = '';
  }else{
    wrap.style.display = 'none';
  }
}
['d2-current','d2-d1','d2-d2'].forEach(id=>{
  document.getElementById(id).addEventListener('input', d2UpdateLossPreview);
});

document.getElementById('d2-calcBtn').addEventListener('click', ()=>{
  const C = n(document.getElementById('d2-current').value);
  const d1 = n(document.getElementById('d2-d1').value)/100;
  const d2 = n(document.getElementById('d2-d2').value)/100;
  const target = document.querySelector('input[name="d2-target"]:checked').value;
  const k = n(document.getElementById('d2-k').value)/100;
  const msg = document.getElementById('d2-msg');
  const out = document.getElementById('d2-out');
  if(!isFinite(C) || C<=0){ msg.innerHTML = '<span class="err">请输入有效的持仓金额。</span>'; out.classList.add('hidden'); return; }
  if(!isFinite(d1)||d1<=0||d1>=1){ msg.innerHTML = '<span class="err">第1天跌幅需在 0%~100% 之间。</span>'; out.classList.add('hidden'); return; }
  if(!isFinite(d2)||d2<=0||d2>=1){ msg.innerHTML = '<span class="err">第2天跌幅需在 0%~100% 之间。</span>'; out.classList.add('hidden'); return; }
  const P0=1.0, P1=P0*(1-d1), P2=P1*(1-d2);
  let PT;
  if(target==='P0') PT=P0;
  else if(target==='P1') PT=P1;
  else if(target==='rebound'){ if(!isFinite(k)||k<=0){ msg.innerHTML='<span class="err">请输入有效的k。</span>'; out.classList.add('hidden'); return; } PT=P2*(1+k); }
  if(PT<=P2){ msg.innerHTML='<span class="err">目标价需高于第2天价格。</span>'; out.classList.add('hidden'); return; }
  const numerator=1-(PT/P0), denominator=(PT/P2)-1;
  let X;
  if(Math.abs(numerator)<1e-12){ X=0; } else { X=C*(numerator/denominator); }
  document.getElementById('d2-need').textContent = (X===Infinity ? '∞' : fmt(X));
  document.getElementById('d2-P2').textContent = P2.toFixed(6);
  document.getElementById('d2-PT').textContent = PT.toFixed(6);
  document.getElementById('d2-total').textContent = fmt(C+(isFinite(X)?X:0));
  msg.innerHTML='<span class="ok">已计算完成。</span>';
  out.classList.remove('hidden');
});
</script>
</body>
</html>
